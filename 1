local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")

local VirtualInputManager = nil
pcall(function() VirtualInputManager = game:GetService("VirtualInputManager") end)
local VirtualUser = nil
pcall(function() VirtualUser = game:GetService("VirtualUser") end)

local LocalPlayer = Players.LocalPlayer

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Parent = game.CoreGui
ScreenGui.Name = "CardCounterPro"
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ScreenGui.ResetOnSpawn = false

local Frame = Instance.new("Frame")
Frame.Size = UDim2.new(0, 280, 0, 200)
Frame.Position = UDim2.new(0.5, -140, 0.2, 0)
Frame.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
Frame.BorderSizePixel = 0
Frame.Active = true
Frame.Draggable = true
Frame.Parent = ScreenGui

local UICorner = Instance.new("UICorner", Frame)
UICorner.CornerRadius = UDim.new(0, 12)

local UIStroke = Instance.new("UIStroke", Frame)
UIStroke.Color = Color3.fromRGB(60, 60, 80)
UIStroke.Thickness = 2

local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, -80, 0, 35)
Title.Position = UDim2.new(0, 15, 0, 5)
Title.BackgroundTransparency = 1
Title.Text = "CARD COUNTER PRO"
Title.Font = Enum.Font.GothamBold
Title.TextSize = 18
Title.TextColor3 = Color3.fromRGB(220, 220, 255)
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.Parent = Frame

local StatusLight = Instance.new("Frame")
StatusLight.Size = UDim2.new(0, 8, 0, 8)
StatusLight.Position = UDim2.new(0, 8, 0, 12)
StatusLight.BackgroundColor3 = Color3.fromRGB(50, 200, 50)
StatusLight.BorderSizePixel = 0
StatusLight.Parent = Frame
local StatusCorner = Instance.new("UICorner", StatusLight)
StatusCorner.CornerRadius = UDim.new(1, 0)

local AutoButton = Instance.new("TextButton")
AutoButton.Size = UDim2.new(0, 30, 0, 30)
AutoButton.Position = UDim2.new(1, -70, 0, 5)
AutoButton.BackgroundColor3 = Color3.fromRGB(40, 40, 60)
AutoButton.Text = "⚡"
AutoButton.TextColor3 = Color3.fromRGB(180, 180, 220)
AutoButton.Font = Enum.Font.GothamBold
AutoButton.TextSize = 16
AutoButton.Parent = Frame
local AutoUICorner = Instance.new("UICorner", AutoButton)
AutoUICorner.CornerRadius = UDim.new(0, 8)
local AutoStroke = Instance.new("UIStroke", AutoButton)
AutoStroke.Color = Color3.fromRGB(80, 80, 120)
AutoStroke.Thickness = 1

local CloseButton = Instance.new("TextButton")
CloseButton.Size = UDim2.new(0, 30, 0, 30)
CloseButton.Position = UDim2.new(1, -35, 0, 5)
CloseButton.BackgroundColor3 = Color3.fromRGB(60, 40, 40)
CloseButton.Text = "×"
CloseButton.TextColor3 = Color3.fromRGB(220, 150, 150)
CloseButton.Font = Enum.Font.GothamBold
CloseButton.TextSize = 20
CloseButton.Parent = Frame
local CloseUICorner = Instance.new("UICorner", CloseButton)
CloseUICorner.CornerRadius = UDim.new(0, 8)
local CloseStroke = Instance.new("UIStroke", CloseButton)
CloseStroke.Color = Color3.fromRGB(120, 80, 80)
CloseStroke.Thickness = 1

CloseButton.MouseButton1Click:Connect(function()
	local tween = TweenService:Create(Frame, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Size = UDim2.new(0, 0, 0, 0), Position = UDim2.new(0.5, 0, 0.2, 0)})
	tween:Play()
	tween.Completed:Wait()
	ScreenGui:Destroy()
	if script then script:Destroy() end
end)

local DragHandle = Instance.new("Frame")
DragHandle.Name = "DragHandle"
DragHandle.Parent = Frame
DragHandle.Size = UDim2.new(1, 0, 0, 40)
DragHandle.Position = UDim2.new(0, 0, 0, 0)
DragHandle.BackgroundTransparency = 1
DragHandle.ZIndex = 2

local dragging, dragStart, startPos
DragHandle.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
		dragging = true
		dragStart = input.Position
		startPos = Frame.Position
		local connection
		connection = input.Changed:Connect(function()
			if input.UserInputState == Enum.UserInputState.End then
				dragging = false
				connection:Disconnect()
			end
		end)
	end
end)
DragHandle.InputChanged:Connect(function(input)
	if (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) and dragging then
		local delta = input.Position - dragStart
		Frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
	end
end)

local Recommendation = Instance.new("TextLabel")
Recommendation.Size = UDim2.new(1, -20, 0, 40)
Recommendation.Position = UDim2.new(0, 10, 0, 45)
Recommendation.BackgroundTransparency = 1
Recommendation.Font = Enum.Font.GothamBlack
Recommendation.TextSize = 28
Recommendation.TextColor3 = Color3.fromRGB(255, 255, 255)
Recommendation.Parent = Frame

local InfoLabel = Instance.new("TextLabel")
InfoLabel.Size = UDim2.new(1, -20, 1, -95)
InfoLabel.Position = UDim2.new(0, 10, 0, 90)
InfoLabel.BackgroundTransparency = 1
InfoLabel.Font = Enum.Font.Gotham
InfoLabel.TextSize = 14
InfoLabel.TextColor3 = Color3.fromRGB(180, 180, 200)
InfoLabel.TextXAlignment = Enum.TextXAlignment.Left
InfoLabel.TextYAlignment = Enum.TextYAlignment.Top
InfoLabel.TextWrapped = true
InfoLabel.RichText = true
InfoLabel.Parent = Frame

local StatsFrame = Instance.new("Frame")
StatsFrame.Size = UDim2.new(1, -20, 0, 20)
StatsFrame.Position = UDim2.new(0, 10, 1, -25)
StatsFrame.BackgroundTransparency = 1
StatsFrame.Parent = Frame

local CardsRemaining = Instance.new("TextLabel")
CardsRemaining.Size = UDim2.new(0.5, -5, 1, 0)
CardsRemaining.Position = UDim2.new(0, 0, 0, 0)
CardsRemaining.BackgroundTransparency = 1
CardsRemaining.Font = Enum.Font.Gotham
CardsRemaining.TextSize = 12
CardsRemaining.TextColor3 = Color3.fromRGB(150, 150, 180)
CardsRemaining.TextXAlignment = Enum.TextXAlignment.Left
CardsRemaining.Text = "Cards: 0"
CardsRemaining.Parent = StatsFrame

local WinRate = Instance.new("TextLabel")
WinRate.Size = UDim2.new(0.5, -5, 1, 0)
WinRate.Position = UDim2.new(0.5, 5, 0, 0)
WinRate.BackgroundTransparency = 1
WinRate.Font = Enum.Font.Gotham
WinRate.TextSize = 12
WinRate.TextColor3 = Color3.fromRGB(150, 150, 180)
WinRate.TextXAlignment = Enum.TextXAlignment.Right
WinRate.Text = "Win Rate: 0%"
WinRate.Parent = StatsFrame

local AutoOn = false
local AutoLoopThread = nil
local AutoAvailable = (VirtualInputManager ~= nil) or (VirtualUser ~= nil)
local GameStats = {Wins = 0, Losses = 0, TotalGames = 0}

local function setAutoAppearance(on)
	if on then
		AutoButton.BackgroundColor3 = Color3.fromRGB(40, 80, 40)
		AutoStroke.Color = Color3.fromRGB(80, 160, 80)
		AutoButton.TextColor3 = Color3.fromRGB(150, 255, 150)
		StatusLight.BackgroundColor3 = Color3.fromRGB(50, 255, 50)
	else
		AutoButton.BackgroundColor3 = Color3.fromRGB(40, 40, 60)
		AutoStroke.Color = Color3.fromRGB(80, 80, 120)
		AutoButton.TextColor3 = Color3.fromRGB(180, 180, 220)
		StatusLight.BackgroundColor3 = Color3.fromRGB(50, 200, 50)
	end
end

local function calculateWinRate()
	if GameStats.TotalGames == 0 then return 0 end
	return math.floor((GameStats.Wins / GameStats.TotalGames) * 100)
end

local function updateStatsDisplay()
	WinRate.Text = "Win Rate: " .. calculateWinRate() .. "%"
end

local function startAutoLoop()
	if AutoLoopThread then return end
	AutoLoopThread = task.spawn(function()
		while AutoOn and ScreenGui.Parent do
			local camera = workspace.CurrentCamera
			if not camera then
				task.wait(1)
				continue
			end
			
			local vx = camera.ViewportSize.X / 2
			local vy = camera.ViewportSize.Y / 2

			local rec = ""
			pcall(function() rec = (Recommendation.Text or ""):upper() end)

			if rec:find("TAKE") then
				local function doLeftClick()
					if VirtualInputManager then
						VirtualInputManager:SendMouseButtonEvent(vx, vy, 0, true, game, 1)
						task.wait(0.02)
						VirtualInputManager:SendMouseButtonEvent(vx, vy, 0, false, game, 1)
					elseif VirtualUser then
						VirtualUser:CaptureController()
						VirtualUser:Button1Down(Vector2.new(vx, vy))
						task.wait(0.02)
						VirtualUser:Button1Up(Vector2.new(vx, vy))
					end
				end
				doLeftClick()
				task.wait(0.1)
				doLeftClick()

			elseif rec:find("HOLD") then
				local function doRightClick()
					if VirtualInputManager then
						VirtualInputManager:SendMouseButtonEvent(vx, vy, 1, true, game, 1)
						task.wait(0.02)
						VirtualInputManager:SendMouseButtonEvent(vx, vy, 1, false, game, 1)
					elseif VirtualUser and VirtualUser.Button2Down then
						VirtualUser:CaptureController()
						VirtualUser:Button2Down(Vector2.new(vx, vy))
						task.wait(0.02)
						VirtualUser:Button2Up(Vector2.new(vx, vy))
					end
				end
				doRightClick()
				task.wait(0.1)
				doRightClick()
			end

			task.wait(1)
		end
		AutoLoopThread = nil
	end)
end

local function stopAutoLoop()
	AutoOn = false
end

AutoButton.MouseButton1Click:Connect(function()
	if not AutoAvailable then
		local originalColor = AutoButton.BackgroundColor3
		local originalStroke = AutoStroke.Color
		AutoButton.BackgroundColor3 = Color3.fromRGB(80, 40, 40)
		AutoStroke.Color = Color3.fromRGB(160, 80, 80)
		task.delay(0.5, function()
			if AutoButton then
				AutoButton.BackgroundColor3 = originalColor
				AutoStroke.Color = originalStroke
			end
		end)
		return
	end

	AutoOn = not AutoOn
	setAutoAppearance(AutoOn)
	if AutoOn then
		startAutoLoop()
	else
		stopAutoLoop()
	end
end)

local lastGameState = {}
local function updateAdvisor()
	local cardsContainer = workspace.Room and workspace.Room:FindFirstChild("Cards")
	local opponentRoot = workspace.Room and workspace.Room.Opponent and workspace.Room.Opponent:FindFirstChild("HumanoidRootPart")
	local myCamera = workspace.Room and workspace.Room:FindFirstChild("Camera")

	local goalValue
	do
		local sumLabel = workspace.Room
			and workspace.Room.Main
			and workspace.Room.Main:FindFirstChild("YourCardsSum")
			and workspace.Room.Main.YourCardsSum:FindFirstChild("SurfaceGui")
			and workspace.Room.Main.YourCardsSum.SurfaceGui:FindFirstChild("TextLabel")
		if sumLabel and sumLabel:IsA("TextLabel") then
			goalValue = tonumber((sumLabel.Text or ""):match("%d+/(%d+)"))
		end
	end

	if not (cardsContainer and opponentRoot and myCamera and goalValue) then
		Recommendation.Text = "WAITING"
		Recommendation.TextColor3 = Color3.fromRGB(255, 255, 100)
		InfoLabel.Text = "Waiting for game data..."
		CardsRemaining.Text = "Cards: 0"
		return
	end

	local myCards, opponentCards = {}, {}
	for _, obj in ipairs(cardsContainer:GetChildren()) do
		if obj.Name == "Card" and obj:IsA("BasePart") then
			local scoreLabel = obj:FindFirstChild("Score") and obj.Score:FindFirstChild("TextLabel")
			local faceValue = scoreLabel and scoreLabel.Text or "[Hidden]"
			local distToOpponent = (obj.Position - opponentRoot.Position).Magnitude
			local distToMe = (obj.Position - myCamera.Position).Magnitude
			local owner = (distToOpponent < distToMe) and "Opponent" or "Me"
			if owner == "Me" then
				table.insert(myCards, faceValue)
			else
				table.insert(opponentCards, faceValue)
			end
		end
	end

	local function cardValue(v)
		if v == "L" then return 99 end
		return tonumber(v)
	end

	local mySum = 0
	for _, v in ipairs(myCards) do
		local n = cardValue(v)
		if n then mySum = mySum + n end
	end

	local oppKnownSum, oppHiddenCount = 0, 0
	for _, v in ipairs(opponentCards) do
		local n = cardValue(v)
		if n then
			oppKnownSum = oppKnownSum + n
		else
			oppHiddenCount = oppHiddenCount + 1
		end
	end

	local deck = {1,2,3,4,5,6,7,8,9,10,11}
	local visibleCards = {}
	for _, v in ipairs(myCards) do
		local n = tonumber(v)
		if n then table.insert(visibleCards, n) end
	end
	for _, v in ipairs(opponentCards) do
		local n = tonumber(v)
		if n then table.insert(visibleCards, n) end
	end
	for _, cardValue in ipairs(visibleCards) do
		for i, deckCard in ipairs(deck) do
			if deckCard == cardValue then
				table.remove(deck, i)
				break
			end
		end
	end

	CardsRemaining.Text = "Cards: " .. #deck

	local safeDraws, bustDraws = 0, 0
	for _, value in ipairs(deck) do
		if mySum + value <= goalValue then
			safeDraws += 1
		else
			bustDraws += 1
		end
	end
	local totalRemaining = safeDraws + bustDraws
	local safeChance = (totalRemaining > 0) and (safeDraws / totalRemaining) or 0

	local sumOfDeck = 0
	for _, v in ipairs(deck) do sumOfDeck += v end
	local avgDeckValue = (totalRemaining > 0) and (sumOfDeck / totalRemaining) or 0
	local oppExpectedSum = oppKnownSum + (oppHiddenCount * avgDeckValue)

	local pointsNeeded = goalValue - mySum
	local opponentBust = oppKnownSum > goalValue

	local requiredSafeChance = 0.50
	local opponentAdvantage = math.max(0, oppExpectedSum - mySum)
	requiredSafeChance = requiredSafeChance - (opponentAdvantage * 0.05)
	requiredSafeChance = math.max(0.40, requiredSafeChance)

	local currentGameState = {
		mySum = mySum,
		oppExpectedSum = oppExpectedSum,
		recommendation = ""
	}

	if opponentBust then
		Recommendation.Text = "HOLD"
		Recommendation.TextColor3 = Color3.fromRGB(220, 80, 80)
		currentGameState.recommendation = "HOLD"
	elseif (1 - safeChance) >= 0.5 and oppExpectedSum <= mySum then
		Recommendation.Text = "HOLD"
		Recommendation.TextColor3 = Color3.fromRGB(220, 80, 80)
		currentGameState.recommendation = "HOLD"
	elseif safeChance >= requiredSafeChance then
		Recommendation.Text = "TAKE"
		Recommendation.TextColor3 = Color3.fromRGB(80, 220, 80)
		currentGameState.recommendation = "TAKE"
	else
		Recommendation.Text = "HOLD"
		Recommendation.TextColor3 = Color3.fromRGB(220, 80, 80)
		currentGameState.recommendation = "HOLD"
	end

	if lastGameState.mySum and lastGameState.mySum ~= currentGameState.mySum then
		if lastGameState.recommendation == "TAKE" and currentGameState.mySum > goalValue then
			GameStats.Losses = GameStats.Losses + 1
			GameStats.TotalGames = GameStats.TotalGames + 1
		elseif lastGameState.recommendation == "HOLD" and currentGameState.oppExpectedSum > goalValue then
			GameStats.Wins = GameStats.Wins + 1
			GameStats.TotalGames = GameStats.TotalGames + 1
		end
		updateStatsDisplay()
	end

	lastGameState = currentGameState

	local deckText = ""
	for i, card in ipairs(deck) do
		local color = (mySum + card <= goalValue) and "<font color='#50FF50'>" or "<font color='#FF5050'>"
		deckText = deckText .. color .. card .. "</font>"
		if i < #deck then deckText = deckText .. ", " end
	end

	InfoLabel.Text = string.format(
		"Safe Chance: <font color='#50FF50'>%.1f%%</font>\nPoints Needed: %d\nOpponent Expected: %.1f\nRemaining: %s",
		safeChance*100,
		pointsNeeded,
		oppExpectedSum,
		deckText
	)
end

RunService.RenderStepped:Connect(updateAdvisor)

local introTween = TweenService:Create(Frame, TweenInfo.new(0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {Size = UDim2.new(0, 280, 0, 200)})
Frame.Size = UDim2.new(0, 0, 0, 0)
introTween:Play()
